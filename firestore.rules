/**
 * # Firestore Security Rules
 *
 * ## Core Philosophy
 * This ruleset establishes a hybrid security model designed for an event registration application.
 * It provides public, read-only access to general event information while enforcing strict,
 * role-based access for sensitive registration data. Administrative users are granted
 * elevated privileges for managing events and viewing registrations.
 *
 * ## Data Structure
 * 1. `/events/{eventId}`: Contains public details about an event. Readable by anyone,
 *    writable only by administrators with a specific role.
 * 2. `/registrations/{registrationId}`: Contains private registration information submitted
 *    publicly. Writable by anyone, but readable only by any authenticated user (admin) to protect PII.
 * 3. `/roles_admin/{adminId}`: A collection for RBAC. The existence of a document with an ID
 *    matching a user's UID grants them administrative privileges for managing events.
 *
 * ## Key Security Decisions
 * - **Default Deny:** All paths are closed by default.
 * - **Public Submissions, Private Reads:** The `/registrations` path allows open write access
 *   (`create`) so anyone can fill out the form. However, read/write access is restricted
 *   to authenticated users, as the admin section is already protected by login.
 * - **Admin Access:** An `isAdmin()` helper function checks for a document in `/roles_admin`,
 *   centralizing admin privilege management for non-registration data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================================================
    // Helper Functions
    // =====================================================================

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    function isExistingDoc() {
      return resource != null;
    }

    // =====================================================================
    // Collection Rules
    // =====================================================================

    /**
     * @description Publicly readable event information. Writes are restricted to admins.
     * @path /events/{eventId}
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Registration data from the public form.
     * @path /registrations/{registrationId}
     * @allow (create) Anyone can submit the registration form.
     * @allow (read, update, delete) Only authenticated users (admins) can manage the list of registrations.
     */
    match /registrations/{registrationId} {
      allow create: if true;
      allow get, list: if isSignedIn();
      allow update, delete: if isSignedIn() && isExistingDoc();
    }

    /**
     * @description Manages administrative roles. This collection should be managed
     *              server-side or via the Firebase Console, not by clients.
     * @path /roles_admin/{adminId}
     */
    match /roles_admin/{adminId} {
      allow get, list: if isAdmin();
      allow create, update, delete: if false; // Prevent client-side role modification.
    }
  }
}
