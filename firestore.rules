/**
 * # Firestore Security Rules
 *
 * ## Core Philosophy
 * This ruleset establishes a hybrid security model designed for an event registration application.
 * It provides public, read-only access to general event information while enforcing that only
 * authenticated users can access sensitive registration data.
 *
 * ## Data Structure
 * 1. `/events/{eventId}`: Contains public details about an event. Readable by anyone,
 *    writable only by authenticated users (admins).
 * 2. `/registrations/{registrationId}`: Contains private registration information submitted
 *    publicly. Writable by anyone, but readable only by any authenticated user to protect PII.
 *
 * ## Key Security Decisions
 * - **Default Deny:** All paths are closed by default.
 * - **Public Submissions, Private Reads:** The `/registrations` path allows open write access
 *   (`create`) so anyone can fill out the form. However, read/write access is restricted
 *   to authenticated users, as the admin section is already protected by login.
 * - **Admin Access:** Any authenticated user is considered an administrator.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================================================
    // Helper Functions
    // =====================================================================

    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is authenticated. In this ruleset, any
     *              signed-in user is considered an administrator for simplicity.
     */
    function isAdmin() {
      return isSignedIn();
    }

    function isExistingDoc() {
      return resource != null;
    }

    // =====================================================================
    // Collection Rules
    // =====================================================================

    /**
     * @description Publicly readable event information. Writes are restricted to admins.
     * @path /events/{eventId}
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Registration data from the public form.
     * @path /registrations/{registrationId}
     * @allow (create) Anyone can submit the registration form.
     * @allow (read, update, delete) Only authenticated users (admins) can manage the list of registrations.
     */
    match /registrations/{registrationId} {
      allow create: if true;
      allow get, list: if isSignedIn();
      allow update, delete: if isSignedIn() && isExistingDoc();
    }

    /**
     * @description This collection is no longer used for role management in the new rules.
     *              Access is denied for client-side operations.
     * @path /roles_admin/{adminId}
     */
    match /roles_admin/{adminId} {
      allow read, write: if false;
    }
  }
}
